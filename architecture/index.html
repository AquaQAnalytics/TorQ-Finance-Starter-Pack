
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="shortcut icon" href="../graphics/favicon.ico">
      
      <meta name="generator" content="mkdocs+mkdocs-material#1.0.2">
    
    
      
        <title>Architecture - Finance Starter Pack</title>
      
    
    
      <script src="../assets/javascripts/modernizr-facb31f4a3.js"></script>
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-1b8b9fdf68.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-02ce7adcc2.palette.css">
      
      
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="indigo" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Finance Starter Pack" class=" md-logo  md-header-nav__button">
          
            <img src="../graphics/TorQ-logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Architecture
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            
              


  


  <a href="https://github.com/AquaQAnalytics/TorQ-Finance-Starter-Pack" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

            
          </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <i class=" md-logo  md-nav__button">
      
        <img src="../graphics/TorQ-logo.png">
      
    </i>
    Finance Starter Pack
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/AquaQAnalytics/TorQ-Finance-Starter-Pack" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  <li class="md-nav__item">
    
      <a href=".." title="Home" class="md-nav__link">
        Home
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../gettingstarted/" title="Getting Started" class="md-nav__link">
        Getting Started
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Architecture
      </label>
    
    <a href="./" title="Architecture" class="md-nav__link md-nav__link--active">
      Architecture
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#processes" title="Processes" class="md-nav__link">
    Processes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feed" title="Feed" class="md-nav__link">
    Feed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rdb" title="RDB" class="md-nav__link">
    RDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wdb-and-sort-processes" title="WDB and Sort Processes" class="md-nav__link">
    WDB and Sort Processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gateway" title="Gateway" class="md-nav__link">
    Gateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#report-engine" title="Report Engine" class="md-nav__link">
    Report Engine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#housekeeping" title="Housekeeping" class="md-nav__link">
    Housekeeping
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compression" title="Compression" class="md-nav__link">
    Compression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discovery" title="Discovery" class="md-nav__link">
    Discovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor" title="Monitor" class="md-nav__link">
    Monitor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" title="Metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-advantages-does-this-give-me" title="What Advantages Does This Give Me?" class="md-nav__link">
    What Advantages Does This Give Me?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#end-of-day" title="End Of Day" class="md-nav__link">
    End Of Day
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gateway-resilience-load-balancing-and-parallel-access" title="Gateway: Resilience, Load Balancing and Parallel Access" class="md-nav__link">
    Gateway: Resilience, Load Balancing and Parallel Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supportability" title="Supportability" class="md-nav__link">
    Supportability
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../play/" title="Have a Play" class="md-nav__link">
        Have a Play
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../iex/" title="IEX" class="md-nav__link">
        IEX
      </a>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#processes" title="Processes" class="md-nav__link">
    Processes
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#feed" title="Feed" class="md-nav__link">
    Feed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rdb" title="RDB" class="md-nav__link">
    RDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wdb-and-sort-processes" title="WDB and Sort Processes" class="md-nav__link">
    WDB and Sort Processes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gateway" title="Gateway" class="md-nav__link">
    Gateway
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#report-engine" title="Report Engine" class="md-nav__link">
    Report Engine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#housekeeping" title="Housekeeping" class="md-nav__link">
    Housekeeping
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compression" title="Compression" class="md-nav__link">
    Compression
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#discovery" title="Discovery" class="md-nav__link">
    Discovery
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor" title="Monitor" class="md-nav__link">
    Monitor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#metrics" title="Metrics" class="md-nav__link">
    Metrics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-advantages-does-this-give-me" title="What Advantages Does This Give Me?" class="md-nav__link">
    What Advantages Does This Give Me?
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#end-of-day" title="End Of Day" class="md-nav__link">
    End Of Day
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gateway-resilience-load-balancing-and-parallel-access" title="Gateway: Resilience, Load Balancing and Parallel Access" class="md-nav__link">
    Gateway: Resilience, Load Balancing and Parallel Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supportability" title="Supportability" class="md-nav__link">
    Supportability
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/AquaQAnalytics/TorQ-Finance-Starter-Pack/edit/master/docs/architecture.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="architecture">Architecture</h1>
<p>This section will be used to describe the different features included
within the Finance Starter Pack. For more information on TorQ
implementation details you can refer to the <a href="https://aquaqanalytics.github.io/TorQ/">TorQ
Manual</a>,
review the code which comprises the system or contact us at
<a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#105;&#110;&#102;&#111;&#64;&#97;&#113;&#117;&#97;&#113;&#46;&#99;&#111;&#46;&#117;&#107;">&#105;&#110;&#102;&#111;&#64;&#97;&#113;&#117;&#97;&#113;&#46;&#99;&#111;&#46;&#117;&#107;</a>.</p>
<h2 id="processes">Processes</h2>
<p>The architecture of the demo system is as below.</p>
<p><img alt="Demo Data Capture" src="../graphics/fullarchitecture.png" /></p>
<h3 id="feed">Feed</h3>
<p>The feed comprises two randomly generated tables, trade and quote. These
tables have ’ticks’ generated by feed.q which are pushed to the
tickerplant in batches every 200 milliseconds. A large batch is pushed
initially then smaller batches after it. The timestamps are local time.</p>
<p>The schema definitions can be seen below and can also be viewed in the
file tick/database.q which will be located under the directory you
extract the TorQ and Starter Pack files to.</p>
<pre><code>quote:([]time:`timestamp$(); sym:`g#`symbol$(); bid:`float$(); ask:`float$(); bsize:`long$(); asize:`long$(); mode:`char$(); ex:`symbol$())
trade:([]time:`timestamp$(); sym:`g#`symbol$(); price:`float$(); size:`int$(); stop:`boolean$(); cond:`char$(); ex:`symbol$())

meta quote
c    | t f a
-----| -----
time | p    
sym  | s   g
bid  | f    
ask  | f    
bsize| j    
asize| j    
mode | c    
ex   | s

meta trade
c    | t f a
-----| -----
time | p    
sym  | s   g
price| f    
size | i    
stop | b    
cond | c    
ex   | s
</code></pre>
<h3 id="rdb">RDB</h3>
<p>The RDB is a TorQ process which holds data for the current GMT day in
memory. Unlike kdb+tick, it does not persist data to disk at end-of-day.</p>
<h3 id="wdb-and-sort-processes">WDB and Sort Processes</h3>
<p>The WDB is a specilized database process which subscribes to a
tickerplant and periodically persists data to disk. At EOD this data is
used to create the HDB partition. It has been configured to operate in
conjuction with a sorting process which sorts the data it writes to
disk.</p>
<p>The sorting process is configured to sort by sym(p#) and time, although
this can be configured on a per-table basis in $KDBCONFIG/sort.csv</p>
<h3 id="gateway">Gateway</h3>
<p>The gateway connects to the RDB and HDB processes and runs queries
against them. It can access a single process, or join data across
multiple processes. It also does load balancing and implements a level
of resilience by hiding back end process failure from clients. Later in
this document in the Have a Pay chapter a number of example queries are
provided which demonstrate the functionality of the gateway process</p>
<h3 id="report-engine">Report Engine</h3>
<p>The Report Engine runs queries on a schedule against specific back end
processes, including gateways. Once the report is complete the result
can be further processed, with available actions such as emailing it out
or writing it to a file. This has been used to implement some basic
monitoring checks and run some end of day reports. The configuration
file is in $KDBCONFIG/reporter.csv.</p>
<h3 id="housekeeping">Housekeeping</h3>
<p>The housekeeping process is used to maintain some of the files written
to disk by TorQ. In the demo we use it to archive tplogs and both
archive and eventually remove log files from the TorQ working
directories.</p>
<p>The process has been configured like so:</p>
<pre><code>zip,{KDBLOG}/,*.log,,10
rm,{KDBLOG}/,*.gz,,30
zip,{KDBHDB}/,database20*,,1
</code></pre>
<p>The first line can be translated to mean ’Compress the files in the
KDBLOG/ path, matching the *.log pattern, excluding no files and
where the files are older than 10 days’</p>
<p>Combined with the other lines, the system will compress process logs
after 10 days, delete compressed process logs after 30 days and compress
tplogs after 1 day.</p>
<p>The compression process will check for work to be done everyday at 0200
local time.</p>
<h3 id="compression">Compression</h3>
<p>The compression process is used to periodically scan the hdb directory
for columnar binary files to compress. The compression settings are
defined in $KDBCONFIG/compressionconfig.csv. This allows configuration
of compression parameters on a per table, column and age basis.</p>
<p>It is intended to be used with a scheduling program like cron. By
default it is a transient process as it will start up, check for files
to compress, does any work required and then dies.</p>
<h3 id="discovery">Discovery</h3>
<p>The discovery process is used by the other processes to locate other
processes of interest, and register their own capabilities.</p>
<h3 id="monitor">Monitor</h3>
<p>The monitor process is a basic monitoring process to show process
avaiability via heartbeating, and to display error messages published by
other processes.</p>
<h3 id="metrics">Metrics</h3>
<p>A simple metrics engine is provided as an example of a real-time
subscriber process. This process subscribes to updates from the 
tickerplant, and provides TWAP and VWAP metrics for configurable time
windows. On connection it subscribes to the tickerplant and attempts 
to recover relevant data up until that point from the RDB. </p>
<p>The settings are shown here:</p>
<table>
<thead>
<tr>
<th align="center">Settings</th>
<th align="center">Type</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">.metrics.windows</td>
<td align="center">timespan (list)</td>
<td align="center">List of time windows over which to perform metrics</td>
</tr>
<tr>
<td align="center">.metrics.enableallday</td>
<td align="center">boolean</td>
<td align="center">Boolean to enable the "all day" window in addition to above windows</td>
</tr>
</tbody>
</table>
<h2 id="what-advantages-does-this-give-me">What Advantages Does This Give Me?</h2>
<p>A standard kdb+tick set up is great for a lot of installations but some
customers have modified it substantially to fit their needs.</p>
<h3 id="end-of-day">End Of Day</h3>
<p>In a standard kdb+tick setup, the end-of-day event is time consuming and
the data is unavailable as it is written from the RDB memory to the HDB
disk. With the above setup, this outage is minimized in the following
ways:</p>
<ul>
<li>
<p>Faster end-of-day as data is written periodically to disk throughout
    the day</p>
</li>
<li>
<p>No back-pressure (slow subscriber problem) on the tickerplant as the
    RDB doesn’t write to disk, and the WDB doesn’t do the time consuming
    sort on the data</p>
</li>
<li>
<p>“Yesterday’s” data is available in the RDB until the end-of-day
    operation is complete, meaning no data outage</p>
</li>
</ul>
<h3 id="gateway-resilience-load-balancing-and-parallel-access">Gateway: Resilience, Load Balancing and Parallel Access</h3>
<p>kdb+tick doesn’t include a gateway as standard. There are some examples
on code.kx, but production gateways are generally non trivial to write.
The TorQ gateway ensures</p>
<ul>
<li>
<p>Backend processes can be replicated as required. If one process
    fails, another will take over transparently to the client</p>
</li>
<li>
<p>New processes can be started intraday and will be automatically
    available via Discovery Service notifications</p>
</li>
<li>
<p>Queries are run in parallel and load balanced across back end
    processes- multiple clients can query at once</p>
</li>
</ul>
<h3 id="supportability">Supportability</h3>
<p>TorQ adds a layer of standard tools to aid system supportability on top
of kdb+tick.</p>
<ul>
<li>
<p>Common directories for loading code in a fault tolerant way</p>
</li>
<li>
<p>Output and error log messages are timestamped and standardized</p>
</li>
<li>
<p>Log messages can be published to external applications</p>
</li>
<li>
<p>All client queries are logged and timed, and can be externally
    published</p>
</li>
<li>
<p>Monitoring checks are incorporated</p>
</li>
<li>
<p>Email notifications are incorporated</p>
</li>
<li>
<p>Housekeeping automatically executed</p>
</li>
</ul>
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../gettingstarted/" title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Getting Started
              </span>
            </div>
          </a>
        
        
          <a href="../play/" title="Have a Play" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Have a Play
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy 2016 AquaQ Analytics Limited.  Kx &reg and kdb+ are registered trademarks of Kx Systems Inc.
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-16f434a21a.js"></script>
      <script>var config={url:{base:".."}},app=new Application(config);app.initialize()</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-51911331-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>